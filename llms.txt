# DadaNanoBC: Nanopore barcoding pipeline

This R package provides functions for clustering and validating amplicon
sequencing data from specimen barcoding projects using Oxford Nanopore.
Although not tested, it should work for PacBio data as well.

- **sample demultiplexing** of pooled reads
- inferring **barcode sequences** using a
  [DADA2](https://benjjneb.github.io/dada2)-based [clustering
  strategy](https://markschl.github.io/DadaNanoBC/articles/workflow.html#clustering)
  to accurately resolve haplotypes/polymorphic sequences
- automatic **taxonomic assignents** and recognition (down-ranking) of
  contaminant taxa
- detailed output files (comprehensive Excel table for curation, HTML
  report, BAM alignment files)

[See here for a comprehensive
explanation](https://markschl.github.io/DadaNanoBC/articles/workflow.html)

A fully-fledged [{targets}](https://books.ropensci.org/targets) pipeline
is provided for simple execution of a standard workflow (see
[below](#running-the-targets-pipeline)).

**Table of contents:**

- [What type of data does it work
  with?](#what-type-of-data-does-it-work-with)
- [System requirements](#system-requirements)
- [Preparation: lab work and
  basecalling](#preparation-lab-work-and-basecalling)
- [Installing and using the package](#installing-and-using-the-package)
- [Running the {targets} pipeline](#running-the-targets-pipeline)
- [Running in the bash console](#running-in-the-bash-console)
- [Required software](#required-software)
- [Useful references](#useful-references)

## What type of data does it work with?

- *Basecalled* amplicon reads with sample-specific tags attached to both
  ends (dual-indexed)
- Reads of sufficient quality (R10.4 chemistry)
- Amplicon lengths of 0.5-1.5kb have been successfully tested
- Works with fixed- and variable-length amplicons from different
  taxonomic groups that can be multiplexed and analyzed separately
- different taxonomic database types can be auto-downloaded (more may be
  implemented in the future)

## System requirements

- An UNIX environment (Linux, OS X or Windows with WSL2) with *Bash*
- An [R](https://cran.r-project.org) installation
- Four command-line programs (see [required
  software](#required-software)); the package can always be installed
  without these, but error messages will appear when calling functions
  that rely on missing components.

If
[basecalling](https://nanoporetech.com/document/data-analysis#basecalling-overview)
of the Nanopore data has not yet been done: an Nvidia GPU with Cuda
support (details
[here](https://markschl.github.io/DadaNanoBC/articles/basecalling.html)).

## Preparation: lab work and basecalling

1.  [Primer
    design](https://markschl.github.io/DadaNanoBC/articles/primers.html)
    ([example
    report](https://markschl.github.io/DadaNanoBC/primer-design-example.html))
2.  [PCR, library preparation and
    sequencing](https://markschl.github.io/DadaNanoBC/articles/lab.html)
3.  [Basecalling](https://markschl.github.io/DadaNanoBC/articles/basecalling.html)

## Installing and using the package

``` r
devtools::install_github("markschl/DadaNanoBC")
```

The package documentation is [found
here](https://markschl.github.io/DadaNanoBC).

The package provides a mix of lower and higher level
[functions](https://markschl.github.io/DadaNanoBC/reference/index.html),
The core clustering function is
[infer_barcode](https://markschl.github.io/DadaNanoBC/reference/infer_barcodes.html)
(detailed [explanation
here](https://markschl.github.io/DadaNanoBC/articles/workflow.html#clustering)).
The high-level pipeline functions all have names starting with `do_`
(e.g. [do_trim_demux](https://markschl.github.io/DadaNanoBC/reference/do_trim_demux.html)).

## Running the {targets} pipeline

In the `R` console (for running in *Bash*, see
[below](#running-in-the-bash-console)):

``` r
setwd("path/to/pipeline")
DadaNanoBC::init_pipeline()
```

Some files are created, some need to be still placed

``` text
path/to/pipeline/
 ├─ _targets.R               Pipeline R code
 └─ analysis/
    ├─ meta-ITS5-ITS4.xlsx   Metadata template (modify & rename to 'meta.xlsx')
    ├─ config.yaml           Pipeline configuration (modify)
    └─ reads.fastq.gz    <- Place base-called nanopore sequences here
```

There may also be warnings about missing software, which have to be
handled (see [required software](#required-software)).

Next:

- Modify the example metadata file `meta-ITS5-ITS4.xlsx` to contain your
  primer sequences and sample metadata, and rename it to **meta.xlsx**
- Copy or move your
  [base-called](https://markschl.github.io/DadaNanoBC/articles/basecalling.html)
  sequencing reads to **reads.fastq.gz**
- Adapt **config.yaml** to your needs; at the minimum, the *taxonony*
  section needs to contain the correct taxonomic database. \> Consider
  starting with a reduced read depth as in the example configuration
  (`max_sample_depth`/`max_contam_sample_depth`)

Run the pipeline:

``` r
targets::tar_make()
```

> *Optional*: Modify the number of parallel processes before calling
> `tar_make`: `Sys.setenv('DadaNanoBC_WORKERS' = 8)`

### Output

Some more files will appear in the analysis directory:

- **report.html** ([example
  report](https://markschl.github.io/DadaNanoBC/analysis-example.html)):
  detailed HTML report, useful for troubleshooting
- **report.xlsx**: Excel report with sequences and taxonomic
  assignments, which can be inspected for issues (see
  [curation](https://markschl.github.io/DadaNanoBC/articles/curation.html))
- **separate_alignments** (and/or *top_alignments*, *alignments*
  depending on configuration): aligned sequencing reads in BAM format,
  may be imported into sequence viewing/editing software such as
  Geneious/CLC Workbench/UGENE/IGV, etc.
- **tmp**: contains temporary (but sometimes useful) data such as the
  demultiplexed FASTQ sample files (sometimes *separate_alignments* with
  many small BAM files, depending on the configuration); if not needed
  you may delete the files

> Inspect the HTML report for anomalies, maybe adjust some other
> settings then re-run with at higher depth (adjust/remove
> `max_sample_depth`/`max_contam_sample_depth`)

### Curation

Excel report contains sequences and issue flags, which might have to be
addressed before exporting the sequences.

[See curation
tutorial](https://markschl.github.io/DadaNanoBC/articles/curation.html)

### Running a different analysis

Prepare another directory with an appropriate `meta.xlsx`,
`reads.fastq.gz` and `config.yaml`. Then, set the path and run the
analysis. Taxonomic databases and other files in the *taxdb* directory
is reused.

``` r
Sys.setenv('DadaNanoBC_ANALYSIS_DIR' = 'path/to/dir')
targets::tar_make()
```

## Running in the bash console

Install the package if not already done

``` sh
Rscript -e 'devtools::install_github("markschl/DadaNanoBC", upgrade = "never")'
```

Initialize a directory where the pipeline is run

``` sh
cd path/to/pipeline
Rscript -e 'DadaNanoBC::init_pipeline(bash = TRUE)'
```

Then make sure there are the files `meta.xlsx`, `reads.fastq.gz` and
`config.yaml` present in the analysis directory as described
[above](#running-the-targets-pipeline).

Run the pipeline (for the default *analysis* directory, may be
[changed](#running-a-different-analysis)):

``` sh
./infer_barcodes analysis
```

Additional settings can be added, as in this more complicated/realistic
example (see also [custom program location](#custom-program-location)):

``` sh
./infer_barcodes WORKERS=8 vsearch=path/to/vsearch
```

[Different analysis](#running-a-different-analysis) in another
directory:

``` sh
./infer_barcodes ANALYSIS_DIR=path/to/analysis
```

## Required software

The following tools are required:

- [seqtool](https://github.com/markschl/seqtool) for primer
  trimming/demultiplexing
- [samtools](https://www.htslib.org) and
  [minimap2](https://github.com/lh3/minimap2) for dealing with
  alignments
- [VSEARCH](https://github.com/torognes/vsearch) for sequence-based
  taxonomic assignments

The above call to
[`init_pipeline()`](https://markschl.github.io/DadaNanoBC/reference/init_pipeline.md)
checks for available software and gives the URLs of missing software.
The following does the same:

``` r
DadaNanoBC::check_system_requirements()
```

The message points to the download locations of missing tools.
*Samtools*, *minimap2* and *VSEARCH* are available from different
sources:

*Debian/Ubuntu* (including Windows WSL2 with these OSes):

``` sh
sudo apt install -y samtools minimap2 vsearch
```

*OS X with [Homebrew](https://brew.sh):*

``` sh
brew install samtools minimap2 vsearch
```

*Conda package manager*
(e.g. [Conda-forge](https://conda-forge.org/download)) (run in the [bash
console](#running-in-the-bash-console)):

``` sh
conda install -y -n DadaNanoBC -c bioconda samtools minimap2 vsearch
conda activate DadaNanoBC
./infer_barcodes analysis_dir [options]
```

Instructions for downloading *Seqtool* are given on the [Github
site](https://github.com/markschl/seqtool/releases).

### Custom program location

R needs to know about the tool’s locations. If not placed at a standard
location, either the `PATH` environment variable needs adjustment, or
the paths can be communicated to DadaNanoBC.

In R (example with VSEARCH):

``` r
DadaNanoBC::set_global_opts(vsearch = '~/Downloads/vsearch-2.30.2-linux-x86_64/bin/vsearch')
tar_make()
```

In the Bash console, simply add `program=...` after the `infer_barcodes`
call:

``` sh
cd path/to/pipeline
./infer_barcodes analysis WORKERS=8 vsearch=~/Downloads/vsearch-2.30.2-linux-x86_64/bin/vsearch
```

## Useful references

- [Srivathsan & Meier
  (2024)](https://doi.org/10.1007/978-1-0716-3581-0_14)
- [Hebert et al. (2024)](https://doi.org/10.1111/1755-0998.14028)
  barcoded up to 100k samples with a single MinION run.
- [ONT barcoding efforts by the MycoMap
  network](https://www.researchgate.net/publication/393048029_Approaching_Full-Scale_DNA_Barcoding_for_North_American_Macrofungi_Highlights_from_the_MycoMap_Network)
  (see also [methods
  description](https://dx.doi.org/10.17504/protocols.io.dm6gpbm88lzp/v4))
  (software used: [NGSpeciesID](https://github.com/ksahlin/NGSpeciesID))

# Package index

## All functions

- [`assign_taxonomy_sintax()`](https://markschl.github.io/DadaNanoBC/reference/assign_taxonomy_sintax.md)
  : Run taxonomy assignment (SINTAX algorithm)
- [`check_system_requirements()`](https://markschl.github.io/DadaNanoBC/reference/check_system_requirements.md)
  : Check external software requirements and report missing programs
- [`compare_seqs()`](https://markschl.github.io/DadaNanoBC/reference/compare_seqs.md)
  : Compare consensus/ASV and known sequences
- [`create_excel_report()`](https://markschl.github.io/DadaNanoBC/reference/create_excel_report.md)
  : Create an Excel report
- [`dada2_denoise()`](https://markschl.github.io/DadaNanoBC/reference/dada2_denoise.md)
  : Run DADA2 denoising
- [`dada_learn_errors()`](https://markschl.github.io/DadaNanoBC/reference/dada_learn_errors.md)
  : Learn error rates
- [`do_combine_alignments()`](https://markschl.github.io/DadaNanoBC/reference/do_combine_alignments.md)
  : Combine all BAM alignment files into a single one
- [`do_demux()`](https://markschl.github.io/DadaNanoBC/reference/do_demux.md)
  : Group sequences by sample index combination
- [`do_infer_all_barcodes()`](https://markschl.github.io/DadaNanoBC/reference/do_infer_all_barcodes.md)
  : Infer barcode sequences for all samples
- [`do_primer_search()`](https://markschl.github.io/DadaNanoBC/reference/do_primer_search.md)
  : Search and remove primer sequences
- [`do_assign_compare_taxonomy()`](https://markschl.github.io/DadaNanoBC/reference/do_taxonomy.md)
  [`do_assign_taxonomy()`](https://markschl.github.io/DadaNanoBC/reference/do_taxonomy.md)
  [`do_compare_taxonomy()`](https://markschl.github.io/DadaNanoBC/reference/do_taxonomy.md)
  : Run the taxonomy assignment and compare with provided taxonomic
  names of specimens
- [`do_trim_demux()`](https://markschl.github.io/DadaNanoBC/reference/do_trim_demux.md)
  : Search and remove primers and sample indexes
- [`fix_homopolymers()`](https://markschl.github.io/DadaNanoBC/reference/fix_homopolymers.md)
  : Attempt at "fixing" the consensus sequence in a homopolymer region
- [`get_gbif_taxa()`](https://markschl.github.io/DadaNanoBC/reference/get_gbif_taxa.md)
  : Match taxonomic names/lineages against the GBIF taxonomy
- [`infer_barcode()`](https://markschl.github.io/DadaNanoBC/reference/infer_barcode.md)
  : Infer barcode sequence(s) from raw reads in a single sample
- [`init_pipeline()`](https://markschl.github.io/DadaNanoBC/reference/init_pipeline.md)
  : Scaffold the targets Pipeline
- [`load_taxdb()`](https://markschl.github.io/DadaNanoBC/reference/load_taxdb.md)
  : Download a taxonomic database and save it in UTAX format
- [`parse_primer_tab()`](https://markschl.github.io/DadaNanoBC/reference/parse_primer_tab.md)
  : Parse a data frame with primer information
- [`parse_sample_tab()`](https://markschl.github.io/DadaNanoBC/reference/parse_sample_tab.md)
  : Parse a data frame with sample metadata
- [`read_xlsx_primer_tab()`](https://markschl.github.io/DadaNanoBC/reference/read_xlsx_primer_tab.md)
  : Read primer information from Excel file
- [`read_xlsx_sample_tab()`](https://markschl.github.io/DadaNanoBC/reference/read_xlsx_sample_tab.md)
  : Read sample metadata from Excel file
- [`set_global_opts()`](https://markschl.github.io/DadaNanoBC/reference/set_global_opts.md)
  : Set global options
- [`try_split_haplotypes()`](https://markschl.github.io/DadaNanoBC/reference/try_split_haplotypes.md)
  : Attempts splitting sequence cluster into two haplotypes.

# Articles

### All vignettes

- [Basecalling](https://markschl.github.io/DadaNanoBC/articles/basecalling.md):
- [Sequence
  curation](https://markschl.github.io/DadaNanoBC/articles/curation.md):
- [Lab methods](https://markschl.github.io/DadaNanoBC/articles/lab.md):
- [Primer
  design](https://markschl.github.io/DadaNanoBC/articles/primers.md):
- [Workflow
  steps](https://markschl.github.io/DadaNanoBC/articles/workflow.md):
