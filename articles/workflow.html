<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Workflow steps • DadaNanoBC</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Workflow steps">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DadaNanoBC</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/basecalling.html">Basecalling</a></li>
    <li><a class="dropdown-item" href="../articles/curation.html">Sequence curation</a></li>
    <li><a class="dropdown-item" href="../articles/lab.html">Lab methods</a></li>
    <li><a class="dropdown-item" href="../articles/primers.html">Primer design</a></li>
    <li><a class="dropdown-item" href="../articles/workflow.html">Workflow steps</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../analysis-example.html">Example Report</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/markschl/DadaNanoBC/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Workflow steps</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/markschl/DadaNanoBC/blob/main/vignettes/workflow.Rmd" class="external-link"><code>vignettes/workflow.Rmd</code></a></small>
      <div class="d-none name"><code>workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="pipeline-steps">Pipeline steps<a class="anchor" aria-label="anchor" href="#pipeline-steps"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Search the primers and short sample indexes (located up-/downstream
of the primer sequences) to group them by sample (de-multiplex); remove
low-quality reads (<code><a href="../reference/do_trim_demux.html">do_trim_demux()</a></code>)</li>
<li>Infer the barcode sequences using a sequential procedure based on <a href="https://benjjneb.github.io/dada2" class="external-link">DADA2</a> and/or fixed-threshold
clustering (with <a href="https://www2.decipher.codes/Clusterize.html" class="external-link">DECIPHER</a>);
compare them with already known sequences if present
(<code><a href="../reference/infer_barcode.html">infer_barcode()</a></code> /
<code><a href="../reference/do_infer_all_barcodes.html">do_infer_all_barcodes()</a></code>)</li>
<li>Auto-assign the taxonomy and compare with the name given by
morphological identification (if present) to validate and check for
contamination (<code><a href="../reference/do_taxonomy.html">do_assign_compare_taxonomy()</a></code>)</li>
<li>Export summary table, which can be further manually curated
(<code><a href="../reference/create_excel_report.html">create_excel_report()</a></code>)</li>
</ol>
</div>
<div class="section level2">
<h2 id="primer-search">Primer search<a class="anchor" aria-label="anchor" href="#primer-search"></a>
</h2>
<p>It is assumed that sample-specific tags are attached to primers on
both sides (dual indexing):</p>
<p><span style="color: #2a90b8ff">TAG1</span><span style="color: #b82ab3ff">FPRIMER</span>BARCODESEQUENCE<span style="color: #b82ab3ff">RPRIMER</span><span style="color: #2a90b8ff">TAG2</span></p>
<p><strong>Combining multiple amplicons</strong> is possible. Primers
are searched in the order that amplicons appear in the sample sheet.
Therefore, if there are <em>nested amplicons</em>, the shorter one
should be placed <em>at the end</em> in the sheet.</p>
</div>
<div class="section level2">
<h2 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h2>
<p>The basic procedure for the clustering is implemented by the
<code><a href="../reference/infer_barcode.html">infer_barcode()</a></code> function. The procedure starts with DADA2
clustering, followed by consensus building. Additional steps may follow
depending on whether the consensus is unambiguous (each alignment column
supported by enough identical bases), or not. The workflow is
illustrated in this flowchart. Relevant configuration options are shown
in <em>grey</em>.</p>
<p><img src="img/cluster-flowchart.png"></p>
<div class="section level3">
<h3 id="stepsstrategies">Steps/strategies<a class="anchor" aria-label="anchor" href="#stepsstrategies"></a>
</h3>
<div class="section level4">
<h4 id="dada2-denoising">DADA2 denoising<a class="anchor" aria-label="anchor" href="#dada2-denoising"></a>
</h4>
<p><a href="https://benjjneb.github.io/dada2" class="external-link">DADA2</a> is a popular
program for inferring sequence variants (ASV) in amplicon sequence data.
The program requires that there are least a few error-free reads
present. If there is not enough duplication, fixed-threshold clustering
(see <a href="#fixed-threshold-clustering">below</a>) is applied
instead.</p>
<p><img src="img/cluster-dada.png"></p>
<p>After obtaining the DADA2 ASV(s), the next step is to infer a <a href="#how-is-the-consensus-sequence-determined-">consensus sequence</a>
for the ASV, which should usually be identical with the ASV sequence.
Ambiguous bases in the consensus sequence may indicate unresolved
sequence variation, which is further addressed by attempting <a href="#haplotype-splitting">haplotype splitting</a> or by more sensitive
denoising (see <a href="#flowchart">flowchart</a>).</p>
</div>
<div class="section level4">
<h4 id="haplotype-splitting">Haplotype splitting<a class="anchor" aria-label="anchor" href="#haplotype-splitting"></a>
</h4>
<p>For DADA2 ASVs with an <span style="color:00897c">ambiguous</span>
consensus, it is checked if there are <strong>two dominant
sequences</strong> (supported by a few identical sequences) serving as
references for splitting the sequencing reads into two similarly
abundant sub-clusters with (ideally) <em>unambiguous</em> sequences. The
splitting is done if the total number of ambiguous bases in the two
resulting consensus sequences is smaller than the number of ambiguous
bases in the original consensus of all combined reads (see also
non-public function <code><a href="../reference/try_split_haplotypes.html">try_split_haplotypes()</a></code>).</p>
<p>This simple procedure is often successful and avoids having to re-run
DADA2 with higher sensitivity, or it may alo resolve InDel variation
that DADA2 did not discover.</p>
<p><img src="img/split-haplo.png"></p>
</div>
<div class="section level4">
<h4 id="fixed-threshold-clustering">Fixed-threshold clustering<a class="anchor" aria-label="anchor" href="#fixed-threshold-clustering"></a>
</h4>
<p>Fixed-threshold clustering is applied to low-coverage samples with
insufficient sequence duplication (see <code>dada_min_identical</code>
and <code>dada_min_n0</code> settings in
<code><a href="../reference/infer_barcode.html">infer_barcode()</a></code>.</p>
<p>By default, single-linkage is applied with a 97% identity threshold
(with <a href="https://www2.decipher.codes/Clusterize.html" class="external-link">DECIPHER</a>). This
can result in an <span style="color:00897c">ambiguous</span> consensus
sequence, which can still be manually inspected.</p>
<p><img src="img/cluster-fixed.png"></p>
</div>
</div>
<div class="section level3">
<h3 id="how-is-the-consensus-sequence-determined">How is the consensus sequence determined?<a class="anchor" aria-label="anchor" href="#how-is-the-consensus-sequence-determined"></a>
</h3>
<p>After DADA2 denoising, haplotype splitting and fixed-threshold
clustering, the raw (quality-filtered) reads are aligned to the
representative sequence (ASV or dominant unique sequence) with <a href="https://lh3.github.io/minimap2" class="external-link">Minimap2</a>.</p>
<p>The consensus sequence is then obtained with <a href="https://www.htslib.org/doc/samtools-consensus.html" class="external-link">samtools
consensus</a> using a simple <strong>frequency-based</strong> approach.
No elaborate neural network-based inference (see e.g. <a href="https://github.com/nanoporetech/medaka" class="external-link">Medaka</a>) is currently
applied.</p>
<p>By default, each base in the consensus sequence needs to be supported
by at least 65% of the reads (weighted by quality scores) to be
<em>unambiguous</em>. Otherwise, an <a href="https://en.wikipedia.org/wiki/Nucleic_acid_notation" class="external-link">ambiguous
base</a> is shown, which may indicate unresolved sequence variation.</p>
<p>The correctness of the consensus is further ensured by re-mapping the
reads against the consensus sequence. If necessary, this step is
repeated until <em>samtools consensus</em> returns the same sequence in
two successive rounds.</p>
<p>The <em>final reported sequence</em> is always the consensus sequence
(see also <code><a href="../articles/curation.html">vignette("curation")</a></code>). If the barcode sample has
a sufficient read depth and sequencing quality, it should usually be
unambiguous and correct. For low-depth samples with ambiguities,
alignments might be inspected manually.</p>
<div class="section level4">
<h4 id="homopolymers">Homopolymers<a class="anchor" aria-label="anchor" href="#homopolymers"></a>
</h4>
<p>The length of <strong>long homopolymer</strong> repeats is often not
very consistent between different sequencing reads, which can result in
<code>N</code> bases in the consensus. In this case, a simple
frequency-based approach is used to “fix” this situation: the
homopolymer length is taken from the <em>most abundant sequence</em>
(see <code><a href="../reference/fix_homopolymers.html">fix_homopolymers()</a></code>).</p>
</div>
</div>
<div class="section level3">
<h3 id="taxa-grouping">Taxa grouping<a class="anchor" aria-label="anchor" href="#taxa-grouping"></a>
</h3>
<p>Sequence variation <em>within</em> taxa (e.g. haplotypes) is
distinguished from <em>between-taxa</em> variation with simple
fixed-threshold single-linkage clustering done with <a href="https://www2.decipher.codes/Clusterize.html" class="external-link">DECIPHER</a>
(default: 97% threshold). This usually works well at least with the ITS
barcode.</p>
<blockquote>
<p>The most problematic case would be if there is a closely related
<strong>contaminant</strong> taxon in the DNA extract, which may not be
well distinghished from the target taxon.</p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="taxonomic-assignments">Taxonomic assignments<a class="anchor" aria-label="anchor" href="#taxonomic-assignments"></a>
</h2>
<p>Taxonomic names are automatically assigned with the the <a href="https://doi.org/10.1101/074161" class="external-link">SINTAX algorithm</a> using a
reference database (see <code><a href="../reference/do_taxonomy.html">do_assign_compare_taxonomy()</a></code>).</p>
<p>Second, taxonomic names associated with the specimens are compared to
the sequence-based taxonomic assignments. From this, a <strong>taxonomic
overlap</strong> is calculated, which is the <em>proportion of matching
ranks in the taxonomic lineages</em> (as far as names are defined at
these levels). The lineages are retrieved from the <a href="https://doi.org/10.15468/39omei" class="external-link">GBIF backbone</a> taxonomy.</p>
<p>Inconsistent taxonomic labels may indicate errors during the
preparation or identification (or possibly the sequence-based
identification), or the presence of contamination. Potential
<strong>dominant contaminants</strong> are automatically flagged (see
<code><a href="../reference/do_taxonomy.html">do_assign_compare_taxonomy()</a></code>, <em>details</em>
section).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Markus Schlegel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
